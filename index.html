<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Dictate - AI Speech to Text</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap">
      {
        "imports": {
          "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
      }
    </script>
</head>
<body class="bg-slate-50 min-h-screen flex items-center justify-center p-4">

    <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-xl border border-slate-200">
        <h1 class="text-2xl font-bold text-slate-800 mb-6 text-center">Gemini DictÃ©e Pro</h1>
        
        <div id="apiKeySection" class="mb-6">
            <div id="apiKeyInputContainer">
                <label class="block text-sm font-medium text-slate-600 mb-1">ClÃ© API Gemini</label>
                <input type="password" id="apiKey" placeholder="Collez votre clÃ© AI Studio ici..."
                    class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 outline-none transition-all">
            </div>
            <div id="apiKeyButton" class="hidden">
                <button id="changeApiKeyBtn" class="w-full px-4 py-2 rounded-lg bg-slate-100 hover:bg-slate-200 text-slate-700 font-medium transition-all border border-slate-300">
                    ðŸ”‘ Modifier la clÃ© API
                </button>
            </div>
        </div>

        <div class="flex flex-col items-center justify-center mb-8">
            <div class="relative">
                <button id="micBtn" class="w-20 h-20 rounded-full bg-green-600 hover:bg-green-700 flex items-center justify-center transition-all shadow-lg group relative z-10">
                    <svg id="micIcon" xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                    </svg>
                    <div id="recordingWave" class="hidden absolute inset-0 rounded-full bg-red-500 animate-ping opacity-50"></div>
                </button>
                <svg id="spinningRing" class="hidden absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-28 h-28 pointer-events-none animate-pulse" viewBox="0 0 100 100">
                    <circle cx="50" cy="50" r="45" fill="none" stroke="#3b82f6" stroke-width="3" opacity="0.5"/>
                </svg>
            </div>
            <p id="status" class="mt-4 text-sm font-medium text-slate-500 uppercase tracking-widest">PrÃªt Ã  enregistrer</p>
        </div>

        <div id="transcriptionSection" class="hidden">
            <div class="flex justify-between items-center mb-1">
                <label class="block text-sm font-medium text-slate-600">Transcription</label>
                <button id="copyBtn" class="text-xs px-3 py-1 rounded-lg bg-blue-500 hover:bg-blue-600 text-white font-medium transition-all">
                    ðŸ“‹ Copier
                </button>
            </div>
            <textarea id="resultArea" disabled
                class="w-full h-40 p-4 rounded-xl bg-slate-100 border border-slate-200 text-slate-700 resize-none font-medium"
                placeholder="Le texte apparaÃ®tra ici aprÃ¨s l'enregistrement..."></textarea>
        </div>

        <p class="text-[10px] text-slate-400 mt-4 text-center italic">
            Note: L'audio est envoyÃ© directement Ã  Google Gemini. Vos donnÃ©es restent privÃ©es.
        </p>
    </div>

    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";

        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;
        let googleColorInterval = null;

        const micBtn = document.getElementById('micBtn');
        const statusText = document.getElementById('status');
        const resultArea = document.getElementById('resultArea');
        const recordingWave = document.getElementById('recordingWave');
        const apiKeyInput = document.getElementById('apiKey');
        const spinningRing = document.getElementById('spinningRing');
        const apiKeyInputContainer = document.getElementById('apiKeyInputContainer');
        const apiKeyButton = document.getElementById('apiKeyButton');
        const changeApiKeyBtn = document.getElementById('changeApiKeyBtn');
        const transcriptionSection = document.getElementById('transcriptionSection');
        const copyBtn = document.getElementById('copyBtn');


        // Fonction simple de chiffrement/dÃ©chiffrement (XOR avec clÃ© dÃ©rivÃ©e du navigateur)
        function encryptKey(key) {
            const salt = navigator.userAgent + window.location.hostname;
            return btoa(String.fromCharCode(...new TextEncoder().encode(key).map((b, i) => b ^ salt.charCodeAt(i % salt.length))));
        }

        function decryptKey(encrypted) {
            try {
                const salt = navigator.userAgent + window.location.hostname;
                const decoded = Uint8Array.from(atob(encrypted), c => c.charCodeAt(0));
                return new TextDecoder().decode(decoded.map((b, i) => b ^ salt.charCodeAt(i % salt.length)));
            } catch {
                return '';
            }
        }

        // Validation de la clÃ© API Gemini
        function isValidApiKey(key) {
            return key && key.length >= 30 && /^[A-Za-z0-9_-]+$/.test(key);
        }

        // Fonction pour changer la couleur du bouton
        function setButtonColor(colorClass, hoverClass = null) {
            // Retirer toutes les classes de couleur existantes
            micBtn.className = micBtn.className.replace(/bg-\w+-\d+/g, '').replace(/hover:bg-\w+-\d+/g, '');
            micBtn.classList.add(colorClass);
            if (hoverClass) {
                micBtn.classList.add(hoverClass);
            }
        }

        // Animation simple du cercle bleu avec le bouton
        function startGoogleColorAnimation() {
            spinningRing.classList.remove('hidden');
            micBtn.classList.add('animate-pulse');
            setButtonColor('bg-blue-500', 'hover:bg-blue-600');
        }

        function stopGoogleColorAnimation() {
            spinningRing.classList.add('hidden');
            micBtn.classList.remove('animate-pulse');
        }

        // Fonction pour basculer l'affichage de la clÃ© API
        function toggleApiKeyDisplay(hasKey) {
            if (hasKey) {
                apiKeyInputContainer.classList.add('hidden');
                apiKeyButton.classList.remove('hidden');
            } else {
                apiKeyInputContainer.classList.remove('hidden');
                apiKeyButton.classList.add('hidden');
            }
        }

        // Charger la clÃ© si elle est dans le localStorage
        const storedKey = localStorage.getItem('gemini_key_enc');
        if (storedKey) {
            const decryptedKey = decryptKey(storedKey);
            apiKeyInput.value = decryptedKey;
            if (decryptedKey) {
                toggleApiKeyDisplay(true);
            }
        }

        // GÃ©rer le clic sur "Modifier la clÃ© API"
        changeApiKeyBtn.onclick = () => {
            toggleApiKeyDisplay(false);
            apiKeyInput.focus();
        };

        // Masquer le bouton et sauvegarder quand on modifie la clÃ©
        apiKeyInput.addEventListener('input', () => {
            const apiKey = apiKeyInput.value.trim();
            if (apiKey && isValidApiKey(apiKey)) {
                localStorage.setItem('gemini_key_enc', encryptKey(apiKey));
            }
        });

        // GÃ©rer le bouton de copie
        copyBtn.onclick = async () => {
            const text = resultArea.value;
            if (text) {
                try {
                    await navigator.clipboard.writeText(text);
                    const originalText = copyBtn.innerHTML;
                    copyBtn.innerHTML = 'âœ“ CopiÃ©';
                    copyBtn.classList.replace('bg-blue-500', 'bg-green-500');
                    copyBtn.classList.replace('hover:bg-blue-600', 'hover:bg-green-600');
                    setTimeout(() => {
                        copyBtn.innerHTML = originalText;
                        copyBtn.classList.replace('bg-green-500', 'bg-blue-500');
                        copyBtn.classList.replace('hover:bg-green-600', 'hover:bg-blue-600');
                    }, 2000);
                } catch (err) {
                    console.error('Erreur de copie:', err);
                    alert('Impossible de copier dans le presse-papier');
                }
            }
        };

        micBtn.onclick = async () => {
            if (!isRecording) {
                startRecording();
            } else {
                stopRecording();
            }
        };

        async function startRecording() {
            const apiKey = apiKeyInput.value.trim();

            if (!apiKey) {
                alert("Veuillez entrer une clÃ© API !");
                return;
            }

            if (!isValidApiKey(apiKey)) {
                alert("Format de clÃ© API invalide. VÃ©rifiez votre clÃ© Gemini.");
                return;
            }

            // Sauvegarder la clÃ© de maniÃ¨re chiffrÃ©e et masquer le champ
            localStorage.setItem('gemini_key_enc', encryptKey(apiKey));
            toggleApiKeyDisplay(true);

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = (event) => audioChunks.push(event.data);
                mediaRecorder.onstop = processAudio;

                mediaRecorder.start();
                isRecording = true;

                // UI - Rouge pendant l'enregistrement
                statusText.innerText = "Enregistrement en cours...";
                statusText.className = 'mt-4 text-sm font-medium text-red-500 uppercase tracking-widest';
                recordingWave.classList.remove('hidden');
                setButtonColor('bg-red-600', 'hover:bg-red-700');
            } catch (err) {
                console.error("Erreur micro:", err);
                alert("Impossible d'accÃ©der au microphone. VÃ©rifiez les permissions.");
            }
        }

        function stopRecording() {
            mediaRecorder.stop();
            isRecording = false;

            // UI
            statusText.innerText = "Analyse par Gemini...";
            statusText.classList.replace('text-red-500', 'text-blue-500');
            recordingWave.classList.add('hidden');

            // DÃ©marrer l'animation des couleurs Google
            startGoogleColorAnimation();
        }

        async function processAudio() {
            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
            const reader = new FileReader();
            
            reader.readAsDataURL(audioBlob);
            reader.onloadend = async () => {
                const base64Data = reader.result.split(',')[1];
                await sendToGemini(base64Data);
            };
        }

        async function sendToGemini(base64Data) {
            try {
                const genAI = new GoogleGenerativeAI(apiKeyInput.value);
                const model = genAI.getGenerativeModel({ model: "gemini-3-flash-preview" });

                const prompt = "Transcris cet audio prÃ©cisÃ©ment. Nettoie les hÃ©sitations (euh, etc.), ajoute la ponctuation correcte et renvoie uniquement le texte transcrit sans commentaires. Le texte retranscrit doit Ãªtre le plus proche possible de ce qui a Ã©tÃ© dictÃ©.";

                const result = await model.generateContent([
                    prompt,
                    { inlineData: { data: base64Data, mimeType: "audio/webm" } }
                ]);

                const text = result.response.text();

                // ArrÃªter l'animation des couleurs Google
                stopGoogleColorAnimation();

                // Affichage et copie
                resultArea.value = text;
                transcriptionSection.classList.remove('hidden');
                await navigator.clipboard.writeText(text);

                statusText.innerText = "TerminÃ© & CopiÃ© !";
                statusText.classList.replace('text-blue-500', 'text-green-600');
                setButtonColor('bg-green-600', 'hover:bg-green-700');

                setTimeout(() => {
                    statusText.innerText = "PrÃªt Ã  enregistrer";
                    statusText.classList.replace('text-green-600', 'text-slate-500');
                    setButtonColor('bg-green-600', 'hover:bg-green-700');
                }, 3000);

            } catch (err) {
                console.error("Erreur Gemini:", err);

                // ArrÃªter l'animation des couleurs Google
                stopGoogleColorAnimation();

                statusText.innerText = "Erreur de traitement";
                statusText.classList.replace('text-blue-500', 'text-red-500');
                setButtonColor('bg-red-600', 'hover:bg-red-700');

                if (err.message && err.message.includes("API_KEY")) {
                    alert("ClÃ© API invalide. VÃ©rifiez votre clÃ© Gemini.");
                } else {
                    alert("Erreur lors du traitement de l'audio. RÃ©essayez.");
                }

                setTimeout(() => {
                    statusText.innerText = "PrÃªt Ã  enregistrer";
                    statusText.classList.replace('text-red-500', 'text-slate-500');
                    setButtonColor('bg-green-600', 'hover:bg-green-700');
                }, 3000);
            }
        }
    </script>
</body>
</html>